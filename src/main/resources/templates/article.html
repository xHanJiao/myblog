<!DOCTYPE html>
<html lang="cn"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title th:text="${article.getTitle()}"></title>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/materialize.min.css}">
    <link th:href="@{/css/quill.css}" rel="stylesheet"/>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->
    <script th:src="@{/js/util.js}"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        p.createTime {
            font-size: medium;
        }

        textarea {
            height: 200px;
        }

        .latch {
            margin-top: 80px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div th:replace="index::header"></div>
<div class="container">
    <div class="row">
        <div class="black-text col m10 s12 offset-m1">
            <div class="row">
                <div>
                    <p class="flow-text center-align" style="font-size: xx-large" th:text="${article.getTitle()}"></p>
                </div>
            </div>
            <div class="row">
                <div>
                    <p class="flow-text right" style="font-size: medium" th:text="${article.getCategory()}"></p>
                </div>
            </div>
            <div class="row">
                <div>
                    <p class="flow-text createTime right" th:text="${article.getCreateTime()}"></p>
                    <input id="articleId" th:value="${article.getId()}" type="hidden"/>
                </div>
            </div>
            <div class="row flow-text articleHolder">
                <p th:utext="${article.getContent()}"></p>
            </div>
            <div class="fixed-action-btn verticle">
                <a class="btn-floating green" title="menu">
                    <i class="material-icons large">menu</i>
                </a>
                <ul>
                    <li th:if="${article.getCommentEnable()}">
                        <a id="commBtn" class="btn-floating blue" title="发表评论"
                           th:if="${article.getState() == 1 || article.getState() == 2}">
                            <i class="material-icons">mode_edit</i> </a>
                    </li>
                    <li>
                        <a id="uphead" class="btn-floating yellow" title="返回顶部">
                            <i class="material-icons">call_merge</i> </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="editBtn">
                        <a class="stateBtn red" id="editBtn" title="修改文章">
                            <i class="material-icons">mode_edit</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="softDelBtn"
                        th:if="${article.getState() == 2 || article.getState() == 1}">
                        <a class="stateBtn yellow deleteBtn" title="删除文章">
                            <i class="material-icons">delete</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="softDelBtn"
                        th:if="${article.getState() == 1}">
                        <a class="stateBtn yellow hideBtn" title="隐藏文章">
                            <i class="material-icons">delete</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="softDelBtn"
                        th:if="${article.getState() == 2}">
                        <a class="stateBtn yellow showBtn" title="显示文章">
                            <i class="material-icons">blur_on</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="vPublishBtn"
                        th:if="${article.getState() == 0}">
                        <a class="stateBtn yellow" id="vPublishBtn" title="公开发布文章">
                            <i class="material-icons">tab</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="uvPublishBtn"
                        th:if="${article.getState() == 0}">
                        <a class="stateBtn blue" id="uvPublishBtn" title="不公开发布文章">
                            <i class="material-icons">tab_unselected</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="hardDelBtn"
                        th:if="${article.getState() == 3}">
                        <a class="stateBtn red deleteBtn" title="彻底删除">
                            <i class="material-icons">delete_forever</i>
                        </a>
                    </li>
                    <li sec:authorize="hasRole('ADMIN')" th:fragment="recoverBtn"
                        th:if="${article.getState() == 3}">
                        <a class="stateBtn red" id="recoverBtn" title="恢复文章">
                            <i class="material-icons">restore</i>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="row" th:if="${article.getCommentEnable()}">
                <div id="addCommDiv">
                    <div class="divider latch"></div>
                    <div>
                        <label for="creator">
                            昵称：<input id="creator" type="text"/>
                        </label>
                    </div>
                    <div>
                        <label for="email">
                            邮箱： <input type="email" id="email">
                        </label>
                    </div>
                    <div>
                        <label for="content">评论:
                            <textarea class="materialize-textarea" id="content"></textarea>
                        </label>
                    </div>
                    <div class="right">
                        <button class="waves-effect waves-light btn" id="sbmt">提交
                        </button>
                    </div>
                </div>
                <div class="divider latch"></div>
            </div>
            <div class="row">
                <p th:text="评论" class="flow-text"></p>
                <div id="comments">
                    <div class="commentsBoard" th:each="comment: ${article.getComments()}">
                        <div>
                            <div class="row">
                                <p th:text="${comment.getContent()}" class="flow-text contentHolder"></p>
                            </div>
                            <div class="row">
                                <div class="right">
                                    <a sec:authorize="hasRole('ADMIN')" class="btn-floating btn red delcomm">
                                        <i class="material-icons">delete</i>
                                    </a>
                                    <input th:value="${comment.creator}" class="replyTo" type="hidden"/>
                                    <a class="btn-floating btn red reply">
                                        <i class="material-icons">chat_bubble</i>
                                    </a>
                                </div>
                            </div>
                            <div class="row">
                                <p th:text="'@' + ${comment.getCreator()} + ' at '
                            + ${comment.getCreateTime()}" class="flow-text right"></p>
                            </div>
                        </div>
                        <div class="divider"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col m2 hide-on-med-and-down">

        </div>
    </div>
    <div th:replace="index::modal"></div>
</div>
<script src="https://cdn.bootcss.com/jquery/2.2.1/jquery.js"></script>
<script th:src="@{/js/materialize.min.js}"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>-->
<script th:src="@{/js/quill.js}"></script>
<script>
    $(document).ready(function () {

        var addCommDiv = $('#addCommDiv');
        addCommDiv.hide();

        $('#commBtn').on('click', function () {
            addCommDiv.toggle();
            $('#content').val("");
            $("html,body").animate({scrollTop: addCommDiv.offset().top}, 1000);
        });

        $('.stateBtn').addClass('btn-floating');

        $('.reply').on('click', function () {
            var title = 'reply to: @' +
                $(this).siblings('input[class=replyTo]').val() + '   ';
            console.log(title);
            addCommDiv.show();
            $('#content').val(title);
            $("html,body").animate({scrollTop: addCommDiv.offset().top}, 1000);
        });

        $('#uphead').on('click', function () {
            $("html,body").animate({scrollTop:0},1000);
            return false;
        });

        $('.delcomm').on('click', function () {
            var delContent = $(this).parents('div[class=row]')
                .prev().find('p').text();
            console.log('delcomm : ' + delContent);
            mockFormKv('/del/comment', 'POST', {content: delContent, articleId: $('#articleId').val()});
        });

        $('#editBtn').on('click', function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/edit/article/' + articleId, 'get', {});
        });

        $('.deleteBtn').on('click', function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/del/article/' + articleId, 'POST', {});
        });

        $('#vPublishBtn').on('click', function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/vpub/article/' + articleId, 'POST', {});
        });

        $('.hideBtn').click(function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/uvpub/article/' + articleId, 'POST', {});
        });

        $('.showBtn').click(function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/vpub/article/' + articleId, 'POST', {});
        });

        $('#uvPublishBtn').on('click', function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            mockFormKv('/uvpub/article/' + articleId, 'POST', {});
        });

        $('#recoverBtn').on('click', function () {
            var articleId = $('#articleId').val();
            console.log('articleId : ' + articleId);
            // mockFormKv('/recover/article/' + articleId, 'POST', {});
            $.post('/recover/article/' + articleId , {}, function () {
                window.location.reload();
            });
        });
    });

    $('#sbmt').click(function () {
        var creator = $('#creator'), email = $('#email'),
            content = $('#content'), URL = '/addcomm',
            articleId = $('#articleId').val();
        // var token = $("meta[name='_csrf']").attr("content");
        // var header = $("meta[name='_csrf_header']").attr("content");
        mockFormKv(URL, "POST", {
            articleId: articleId, email: email.val(),
            content: content.val(), creator: creator.val()
            // , _csrf: token, _csrf_header: header});
        });
        return true;
    });
</script>
</body>
</html>